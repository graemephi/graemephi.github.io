<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="So, despite saying I didn&rsquo;t want to do this in my last post on this, I went and forked Hugo. Now rendering with KaTeX is way faster, and basically free when using hugo server.">
<meta property="og:title" content="Server-side KaTeX With Hugo: Part 2">
<meta property="og:description" content="So, despite saying I didn&rsquo;t want to do this in my last post on this, I went and forked Hugo. Now rendering with KaTeX is way faster, and basically free when using hugo server.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://graemephi.github.io/posts/server-side-katex-with-hugo-part-2/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-01-19T00:00:00+00:00">
<meta property="article:modified_time" content="2020-01-19T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Server-side KaTeX With Hugo: Part 2">
<meta name=twitter:description content="So, despite saying I didn&rsquo;t want to do this in my last post on this, I went and forked Hugo. Now rendering with KaTeX is way faster, and basically free when using hugo server.">
<meta name=twitter:site content="@graemephi">
<meta name=generator content="Hugo 0.90.0-DEV">
<title>Server-side KaTeX With Hugo: Part 2 - graeme. hello</title>
<link href=/css/katex.min.css rel=stylesheet type=text/css>
<style>body{background-color:#fffdfc;font-family:Georgia,times new roman,serif;font-size:1em;margin:0 2em;line-height:1.4em}body *{margin-left:auto;margin-right:auto}a.footnote-backref{visibility:hidden;font-size:.66em}a.footnote-backref::before{visibility:visible;content:"back"}.content{width:42em}@media(max-width:49.1228em){.content{width:85vw}}.about{margin:0}.page-header{align-items:center;display:flex;justify-content:space-between}.name{margin-left:1em;margin-right:auto}.post-header{align-items:baseline;color:#5a5857;display:flex;flex-flow:wrap;justify-content:space-between;line-height:.5em}a{color:#000;text-decoration-color:#5a5857;text-decoration:underline}a:hover{color:#ffa000;text-decoration-color:#d18400}.icon:hover{fill:#ffa000}h1>a,h2>a,h3>a,h4>a,a.icon{text-decoration:none}hr{border:0;height:0;border-top:1px solid rgba(87,44,0,.1)}.svgi>svg{vertical-align:middle}code{font-family:consolas;font-size:.8em;overflow-x:scroll;max-width:100%}.tags{align-items:baseline;color:#5a5857;display:flex;flex-flow:wrap;line-height:1em;list-style-type:none;padding:0}.tags.post-tags{font-size:.9em;justify-content:flex-end;margin:0}.tags.all-tags{justify-content:flex-start;margin:-1em 0}.list-tags{margin:-1em 0}.tags a{color:#2d2c2b}.post-tags a{text-decoration:none}.tags>li{margin:0 .1em}.post{margin:2em auto}.post img{display:block;margin:0 auto;max-width:calc(100vw - 1em);height:auto}.text-align-right{text-align:right}.rss-link{font-size:.8em;text-align:right}.post-title{line-height:1em}.katex{font-size:large}pre.terminal,pre>code.language-terminal{background:#272822;padding:.66em 1em;padding:1em 2em;margin:1em -1em;color:#f8f8f2;display:block;border-radius:5px}p code{background:#feeee7;padding:.1em .2em}.katex-display>.katex{font-size:larger}.highlight>pre{position:relative;padding:1em 2em;margin:1em -1em;overflow-x:auto}.highlight code{font-size:.83em}.img-flex{background-color:#fffdfc;display:flex;justify-content:center;flex-wrap:wrap;position:relative;width:100vw;left:calc(50% - 50vw)}.img-flex>img{margin:.5em}@media(min-width:84em){.img-flex{width:84em;left:calc(50% - 42em)}}.katex-display>.katex{max-width:100%;overflow-x:scroll}table{margin:1em -1em;border-collapse:separate;border-spacing:0;border-radius:5px;width:calc(100% + 2em);overflow-x:scroll;border:1px solid hsla(20,58%,46%,.2)}th,td{padding:.5em 1em;border-right:1px solid hsla(20,58%,46%,.1)}th{font-weight:700;border-bottom:1px solid hsla(20,58%,46%,.1);background-color:#fbf3ef;text-align:left}td{border-bottom:1px solid hsla(20,58%,46%,.1)}tr:last-child td{border-bottom:none}td:last-child,th:last-child{border-right:none}blockquote{padding:.5em 1.5em;margin:1em .5em;display:block;border-radius:0;background-color:transparent;border-left:3px solid hsla(20,58%,46%,12%);position:relative}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}blockquote cite{display:block;font-style:normal;font-size:.9em;text-align:right;margin-top:.5em;color:#272625}blockquote.aside{padding:1em 1.5em;margin:1em -1em;display:block;border-radius:5px;background-color:#fbf3ef;border-style:outset;border-color:hsla(20,58%,46%,4%)}p{margin-bottom:1.1em}.content p,.post p,blockquote p{line-height:1.45em}a{text-decoration-thickness:1px;text-underline-offset:2px}h1,h2,h3,h4{margin-top:1.5em;margin-bottom:.7em;line-height:1.2}p,li,blockquote{letter-spacing:.01em}</style>
</head>
<body>
<div class=content>
<header class=page-header>
<span style=display:inline-flex;flex-direction:column>
<h3 class=page-title><a href=/><span>graeme. hello</span></a></h3>
</span>
<span class=links>
<a href=https://github.com/graemephi class="github icon" title=Github><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
</a>
<a href=https://mastodon.gamedev.place/@graeme class="mastodon icon" title=Mastodon><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 418 512" fill="currentcolor" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</a>
</span>
</header>
<div class=post-header>
<h1 class=post-title><a href=/posts/server-side-katex-with-hugo-part-2/>Server-side KaTeX With Hugo: Part 2</a></h1>
</div>
<div class=text-align-right>
<span class=date>January 19, 2020</span>
<br>
</div>
<div class=post>
<p>So, despite saying I didn&rsquo;t want to do this in my <a href=/posts/static-katex-with-hugo/>last post</a> on this, <a href=https://github.com/graemephi/kahugo>I went and forked Hugo</a>. Now rendering with KaTeX is way faster, and basically free when using <code>hugo server</code>.</p>
<p>This was more driven by curiosity than a desire to make things fast. At some point a couple weeks ago I was reminded of <a href=https://bellard.org/quickjs/>QuickJS</a>, and from there it was a short series of small steps to my downfall. QuickJS really enabled this. It was easy to replace the javascript from my previous post with an executable that ran the qjs interpreter on KateX bytecode, and easy to then link it to a Haskell program that drove Pandoc as a library rather than using the command line. Having done <em>that</em>, getting Goldmark, Hugo&rsquo;s markdown processor, to render TeX using KaTeX was also a small amount of work.</p>
<p>Rather than this post just being, &ldquo;hey, I&rsquo;m doing this now instead,&rdquo; I guess I&rsquo;ll talk a bit more about it.</p>
<p>Goldmark is fairly extensible so shoe-horning in TeX-awareness just means telling Goldmark&rsquo;s parser to call our code when it hits a <code>$</code>: I put maths between <code>$</code> and <code>$$</code>, so <code>$x$</code> gets rendered as <span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.43056em;vertical-align:0></span><span class="mord mathdefault">x</span></span></span></span>. But taking responsibility for parsing any markdown yourself means you have to think about weird edge cases<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p>
<p>Take links. Links in markdown have the following syntax: <code>[foo](bar.tld)</code>. So, how should <code>[$foo](bar.tld$)</code> be parsed? In my opinion, there is a correct answer here: that&rsquo;s a link. I&rsquo;ve found people citing some old RFC that prohibits $ in urls, but <a href=https://en.wikipedia.org/wiki/$>they&rsquo;re valid</a>. Anyone who writes <code>[$](en.wikipedia.org/wiki/$)</code> wants that to be a link, and I can&rsquo;t think of any exceptions.</p>
<p>By the way, that $ in the previous paragraph also needs to be parsed as a $, and not the opening dollar of maths.</p>
<p>So, those are links. What about <code>[$[0, 1]$](url)</code>? There&rsquo;s something satisfying about being able to link maths: <a href=https://en.wikipedia.org/wiki/Unit_interval><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>[</span><span class=mord>0</span><span class=mpunct>,</span><span class=mspace style=margin-right:.16666666666666666em></span><span class=mord>1</span><span class=mclose>]</span></span></span></span></a>. So, that first example we want to not parse as TeX, and the second we do, and in order to support both we have to know if we are inside a link or not. Parsing!</p>
<p>Thankfully, we have a working TeX-aware markdown processor already: Pandoc. After fixing up some minor differences between how Goldmark and Pandoc renders the HTML, Pandoc, with the old filter from last time, can <a href=https://github.com/graemephi/goldmark-qjs-katex/blob/master/gen.go>generate a bunch of test cases</a>. I don&rsquo;t follow Pandoc&rsquo;s example in one place; Pandoc&rsquo;s rule for allowing <code>$[]$</code> inside links seems to be that the brackets must be balanced. I opted for requiring <code>[</code> to appear before <code>]</code> (which would otherwise close the link).</p>
<p>Next, some threading stuff. Hugo uses goroutines, and the QuickJS runtime can only be used single-threaded. We don&rsquo;t want to make each goroutine queue to access QuickJS, and we also want to keep our changes to Hugo to a minimum. From a C perspective, there&rsquo;s a really obvious solution: give each thread its own QuickJS runtime using thread-local storage. But goroutines aren&rsquo;t threads, and the Go scheduler wants to schedule goroutines to any thread it likes. This means that between two calls into QuickJS the goroutine can move thread, and whatever way we have of communicating with the QuickJS runtime from Go needs to be okay with this happening.</p>
<p>What I decided to do was to just never allocate anything that would be passed back to Go, and have the Go code pass in memory instead. This makes the C code pure as far as Go is concerned, so we can use thread-local and not worry about the Go scheduler. It also means we don&rsquo;t have to call free, which is always good.</p>
<p>Last time, I reported that a single page with TeX took half a second to render. Now, my entire site takes 240ms. Without KaTeX, it&rsquo;s around 150ms. I still find this a bit slower than it really ought to be, but I suppose for how little work it was, it&rsquo;s pretty good.</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>The <a href=https://spec.commonmark.org/>Commonmark spec</a> is a great resource for all the markdown parsing gotchas you&rsquo;ve never thought about before.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div>
<blockquote class=aside>
<noscript><p style=margin:auto>There might be <a href=https://utteranc.es>utteranc.es</a> comments here when javascript is on.</p></noscript>
<script src=https://utteranc.es/client.js repo=graemephi/graemephi.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script>
</blockquote>
<h2>More Posts</h2>
<ol reversed>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/spectrogram-phases/>Spectrogram Phases</a> (2025-09-28)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/twelve-tones/>Twelve tones are inescapable</a> (2025-03-31)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/unique-random-numbers/>Generating Unique Random Numbers</a> (2024-09-27)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/modular-forms/>WTF Are Modular Forms</a> (2024-03-25)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/some-low-discrepancy-noise-functions/>Some low discrepancy noise functions</a> (2022-08-10)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/difference-decay/>Difference Decay</a> (2021-12-29)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/stb_ds-string-interning/>stb_ds: string interning</a> (2020-08-27)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/deep-sky-object/>deep sky object</a> (2020-05-20)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/calculating-lod/>Calculating LOD</a> (2019-12-31)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/triangle-dft/>The Discrete Fourier Transform, But With Triangles</a> (2019-12-14)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/dumb-tricks-with-phase-inversion/>Dumb Tricks With Phase Inversion</a> (2019-06-02)
</li>
</ol>
<div class=rss-link>
<a href=/index.xml title=RSS>rss</a>
</div>
</div>
</body>
</html>