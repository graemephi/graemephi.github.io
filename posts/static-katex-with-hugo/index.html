<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Update (2020-01-19): I lasted some 3 weeks before gettng rid of this. Also, I&rsquo;ve changed the title from &lsquo;static&rsquo; to &lsquo;server-side&rsquo; which is more accurate.

Hugo is a static website generator written in Go. Katex is a math typesetting library written in Javascript. This site uses them both.">
<meta property="og:title" content="Server-side KaTeX With Hugo">
<meta property="og:description" content="Update (2020-01-19): I lasted some 3 weeks before gettng rid of this. Also, I&rsquo;ve changed the title from &lsquo;static&rsquo; to &lsquo;server-side&rsquo; which is more accurate.

Hugo is a static website generator written in Go. Katex is a math typesetting library written in Javascript. This site uses them both.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://graemephi.github.io/posts/static-katex-with-hugo/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-12-15T18:01:49+00:00">
<meta property="article:modified_time" content="2019-12-15T18:01:49+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Server-side KaTeX With Hugo">
<meta name=twitter:description content="Update (2020-01-19): I lasted some 3 weeks before gettng rid of this. Also, I&rsquo;ve changed the title from &lsquo;static&rsquo; to &lsquo;server-side&rsquo; which is more accurate.

Hugo is a static website generator written in Go. Katex is a math typesetting library written in Javascript. This site uses them both.">
<meta name=twitter:site content="@graemephi">
<meta name=generator content="Hugo 0.90.0-DEV">
<title>Server-side KaTeX With Hugo - graeme. hello</title>
<link href=/css/katex.min.css rel=stylesheet type=text/css>
<style>body{background-color:#fffdfc;font-family:Georgia,times new roman,serif;font-size:1em;margin:0 2em;line-height:1.4em}body *{margin-left:auto;margin-right:auto}a.footnote-backref{visibility:hidden;font-size:.66em}a.footnote-backref::before{visibility:visible;content:"back"}.content{width:42em}@media(max-width:49.1228em){.content{width:85vw}}.about{margin:0}.page-header{align-items:center;display:flex;justify-content:space-between}.name{margin-left:1em;margin-right:auto}.post-header{align-items:baseline;color:#5a5857;display:flex;flex-flow:wrap;justify-content:space-between;line-height:.5em}a{color:#000;text-decoration-color:#5a5857;text-decoration:underline}a:hover{color:#ffa000;text-decoration-color:#d18400}.icon:hover{fill:#ffa000}h1>a,h2>a,h3>a,h4>a,a.icon{text-decoration:none}hr{border:0;height:0;border-top:1px solid rgba(87,44,0,.1)}.svgi>svg{vertical-align:middle}code{font-family:consolas;font-size:.8em;overflow-x:scroll;max-width:100%}.tags{align-items:baseline;color:#5a5857;display:flex;flex-flow:wrap;line-height:1em;list-style-type:none;padding:0}.tags.post-tags{font-size:.9em;justify-content:flex-end;margin:0}.tags.all-tags{justify-content:flex-start;margin:-1em 0}.list-tags{margin:-1em 0}.tags a{color:#2d2c2b}.post-tags a{text-decoration:none}.tags>li{margin:0 .1em}.post{margin:2em auto}.post img{display:block;margin:0 auto;max-width:calc(100vw - 1em);height:auto}.text-align-right{text-align:right}.rss-link{font-size:.8em;text-align:right}.post-title{line-height:1em}.katex{font-size:large}pre.terminal,pre>code.language-terminal{background:#272822;padding:.66em 1em;padding:1em 2em;margin:1em -1em;color:#f8f8f2;display:block;border-radius:5px}p code{background:#feeee7;padding:.1em .2em}.katex-display>.katex{font-size:larger}.highlight>pre{position:relative;padding:1em 2em;margin:1em -1em;overflow-x:auto}.highlight code{font-size:.83em}.img-flex{background-color:#fffdfc;display:flex;justify-content:center;flex-wrap:wrap;position:relative;width:100vw;left:calc(50% - 50vw)}.img-flex>img{margin:.5em}@media(min-width:84em){.img-flex{width:84em;left:calc(50% - 42em)}}.katex-display>.katex{max-width:100%;overflow-x:scroll}table{margin:1em -1em;border-collapse:separate;border-spacing:0;border-radius:5px;width:calc(100% + 2em);overflow-x:scroll;border:1px solid hsla(20,58%,46%,.2)}th,td{padding:.5em 1em;border-right:1px solid hsla(20,58%,46%,.1)}th{font-weight:700;border-bottom:1px solid hsla(20,58%,46%,.1);background-color:#fbf3ef;text-align:left}td{border-bottom:1px solid hsla(20,58%,46%,.1)}tr:last-child td{border-bottom:none}td:last-child,th:last-child{border-right:none}blockquote{padding:.5em 1.5em;margin:1em .5em;display:block;border-radius:0;background-color:transparent;border-left:3px solid hsla(20,58%,46%,12%);position:relative}blockquote p:first-of-type{margin-top:0}blockquote p:last-of-type{margin-bottom:0}blockquote cite{display:block;font-style:normal;font-size:.9em;text-align:right;margin-top:.5em;color:#272625}blockquote.aside{padding:1em 1.5em;margin:1em -1em;display:block;border-radius:5px;background-color:#fbf3ef;border-style:outset;border-color:hsla(20,58%,46%,4%)}p{margin-bottom:1.1em}.content p,.post p,blockquote p{line-height:1.45em}a{text-decoration-thickness:1px;text-underline-offset:2px}h1,h2,h3,h4{margin-top:1.5em;margin-bottom:.7em;line-height:1.2}p,li,blockquote{letter-spacing:.01em}</style>
</head>
<body>
<div class=content>
<header class=page-header>
<span style=display:inline-flex;flex-direction:column>
<h3 class=page-title><a href=/><span>graeme. hello</span></a></h3>
</span>
<span class=links>
<a href=https://github.com/graemephi class="github icon" title=Github><svg height="30" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" width="30" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg>
</a>
<a href=https://mastodon.gamedev.place/@graeme class="mastodon icon" title=Mastodon><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 418 512" fill="currentcolor" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
</a>
</span>
</header>
<div class=post-header>
<h1 class=post-title><a href=/posts/static-katex-with-hugo/>Server-side KaTeX With Hugo</a></h1>
</div>
<div class=text-align-right>
<span class=date>December 15, 2019</span>
<br>
</div>
<div class=post>
<p><strong>Update</strong> (2020-01-19): <a href=/posts/server-side-katex-with-hugo-part-2>I lasted some 3 weeks before gettng rid of this</a>. Also, I&rsquo;ve changed the title from &lsquo;static&rsquo; to &lsquo;server-side&rsquo; which is more accurate.</p>
<hr>
<p><a href=https://gohugo.io/>Hugo</a> is a static website generator written in Go. <a href=https://katex.org/>Katex</a> is a math typesetting library written in Javascript. This site uses them both.</p>
<p>I keep javascript turned off on websites unless white-listed. I notice when websites fail to load without javascript and I notice when websites don&rsquo;t require it at all. I&rsquo;d like mine to be one of the latter, but also, I want to have proper maths typesetting. Now, usually the way you get maths onto the internet is you dump some LaTeX surrounded by $$ into a document, embed some random javascript file, and everything happens automatically. I don&rsquo;t like that.</p>
<p>What I want instead is for Hugo to typeset my maths. But I still want <code>hugo server</code> to render everything properly, and I don&rsquo;t want a complicated multi-stage build process, and I <em>really</em> don&rsquo;t want to maintain my own build of Hugo. Basically, I want to be able to dump the Hugo executable somewhere and have everything work when I type</p>
<pre tabindex=0><code class=language-terminal data-lang=terminal>cd blog
hugo
</code></pre><p>Unfortunately, Hugo doesn&rsquo;t really support Katex per se. It uses Markdown parsers that know to leave text surrounded by $$ alone, and Katex searches for them at page-load. These parsers are compiled into Hugo, and at no point can you intercept them to do further processing of your own.</p>
<p>But Hugo supports <a href=https://pandoc.org/>Pandoc</a>, and Pandoc is happy to pass you a copy of the AST to fiddle with before it actually renders anything. What&rsquo;s more, Pandoc knows that $ means inline maths and $$ means display maths, so we can just read that information off of the AST and have Katex format it as inline or display appropriately.</p>
<p>So, the outlines of a solution are starting to appear. We need to write a <a href=https://pandoc.org/filters.html>Pandoc filter</a> that replaces LaTeX maths with Katex&rsquo;s HTML typesetting.</p>
<p>But there is a problem. There are two problems.</p>
<ol>
<li>
<p>Hugo&rsquo;s support of Pandoc is fairly limited. The command-line parameters it uses are hard-coded into Hugo, and they seem to just be whatever the guy who committed the PR adding Pandoc support needed (thanks to that guy, by the way. We couldn&rsquo;t get even this far without him). We need to pass our own arguments to get Pandoc to filter anything.</p>
</li>
<li>
<p>Pandoc doesn&rsquo;t support passing arguments to filters. We can tell Pandoc to execute <code>node</code>, but we can&rsquo;t tell Pandoc to execute <code>node katex.js</code>. This seems to be a weird artifact of how Pandoc shells out to filters, at least on Windows.</p>
</li>
</ol>
<p>There is a simple, elegant, and generally terrible solution to both of these problems.</p>
<p>The reason Hugo can call out to Pandoc, and the reason Pandoc can call out to Node, at all, is because they&rsquo;re both in <code>PATH</code>. So, we just have to arrange <code>PATH</code> to our liking before running Hugo. I always run Hugo from VSCode, so I can do this on a per-project basis, and not contaminate the rest of my system with this, ah, workaround.</p>
<p>I didn&rsquo;t investigate the best way to do this; I suspect on Linux it would be a bit easier. But, on Windows, I didn&rsquo;t want to think too hard about it, so I just compiled a couple C programs. Now I have the following folder structure:</p>
<pre tabindex=0><code class=language-terminal data-lang=terminal>blog/
├── content/
├── ...
└── pandoc/
     ├── node_modules/
     ├── katex.exe
     ├── katex.js
     └── pandoc.exe
</code></pre><p>The first directory in <code>PATH</code> whenever I run Hugo is <code>path/to/blog/pandoc</code>. <code>node_modules</code> contains only Katex, required by <code>katex.js</code>, the pandoc filter. <code>katex.exe</code> opens a pipe to <code>node pandoc/katex.js</code> and <code>pandoc.exe</code> opens a pipe to <code>pandoc --katex --filter=katex</code>. Full paths to these are hard-coded into the executables, because I never learn.</p>
<p>Then, in the front matter for a post that needs Katex, we use the Pandoc renderer:</p>
<pre tabindex=0><code class=language-terminal data-lang=terminal>---
title: &quot;Static Katex With Hugo&quot;
date: 2019-12-16T02:01:49Z
markup: pandoc
---
</code></pre><p>The code for the executables and Pandoc filter are pretty rote. <a href=https://gist.github.com/graemephi/7c60093f342b6dabf00d976492b6c91f>Here&rsquo;s a gist, if you&rsquo;re interested.</a></p>
<p>There&rsquo;s one big problem with this. It&rsquo;s slow. For every post with maths to typeset, we have to shell out to pandoc and then it has to shell out to Node. This takes around 500ms per page for me, as opposed to 40ms for other pages. Pandoc without a filter, by the way, takes about 80ms. I can live with this for single posts as I&rsquo;m writing, but I suspect before long I won&rsquo;t be able to stand how long a full build takes.</p>
<p>That 500ms is mostly spent starting up Node and initialising Katex. So, one solution is to keep Node running and pass all the posts to a single instance. That doesn&rsquo;t sound too hard to do myself, but my hope is Hugo will have made some progress on that themselves before I feel the need to&ndash;there are now so many preprocessors written in javascript they&rsquo;re already thinking about it, as far as I know. But what you really want is a LaTeX to HTML renderer written in Go.</p>
<p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mi>i</mi><mi>π</mi></mrow></msup><mo>+</mo><mn>1</mn><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex"> e^{i\pi} + 1 = 0 </annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9579939999999999em;vertical-align:-.08333em></span><span class=mord><span class="mord mathdefault">e</span><span class=msupsub><span class=vlist-t><span class=vlist-r><span class=vlist style=height:.8746639999999999em><span style=top:-3.113em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style=margin-right:.03588em>π</span></span></span></span></span></span></span></span></span><span class=mspace style=margin-right:.2222222222222222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222222222222222em></span></span><span class=base><span class=strut style=height:.64444em;vertical-align:0></span><span class=mord>1</span><span class=mspace style=margin-right:.2777777777777778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2777777777777778em></span></span><span class=base><span class=strut style=height:.64444em;vertical-align:0></span><span class=mord>0</span></span></span></span></span></p>
</div>
<blockquote class=aside>
<noscript><p style=margin:auto>There might be <a href=https://utteranc.es>utteranc.es</a> comments here when javascript is on.</p></noscript>
<script src=https://utteranc.es/client.js repo=graemephi/graemephi.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script>
</blockquote>
<h2>More Posts</h2>
<ol reversed>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/spectrogram-phases/>Spectrogram Phases</a> (2025-09-28)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/twelve-tones/>Twelve tones are inescapable</a> (2025-03-31)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/unique-random-numbers/>Generating Unique Random Numbers</a> (2024-09-27)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/modular-forms/>WTF Are Modular Forms</a> (2024-03-25)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/some-low-discrepancy-noise-functions/>Some low discrepancy noise functions</a> (2022-08-10)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/difference-decay/>Difference Decay</a> (2021-12-29)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/stb_ds-string-interning/>stb_ds: string interning</a> (2020-08-27)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/deep-sky-object/>deep sky object</a> (2020-05-20)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/calculating-lod/>Calculating LOD</a> (2019-12-31)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/triangle-dft/>The Discrete Fourier Transform, But With Triangles</a> (2019-12-14)
</li>
<li style=list-style:none>
<a href=https://graemephi.github.io/posts/dumb-tricks-with-phase-inversion/>Dumb Tricks With Phase Inversion</a> (2019-06-02)
</li>
</ol>
<div class=rss-link>
<a href=/index.xml title=RSS>rss</a>
</div>
</div>
</body>
</html>